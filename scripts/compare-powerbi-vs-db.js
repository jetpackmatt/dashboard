#!/usr/bin/env node
/**
 * Compare PowerBI data against our DB to find discrepancies
 */
require('dotenv').config({ path: '.env.local' })
const { createClient } = require('@supabase/supabase-js')

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
)

// PowerBI data - Reference ID to Amount mapping
const powerBIData = `330577503	0.52
330697308	0.52
330658708	0.52
330663348	0.52
330648718	0.52
330570951	0.52
330542192	0.52
330424694	0.52
330435763	0.52
330293416	0.52
330288739	0.52
330247594	0.52
330245513	0.52
330712934	0.52
330663465	0.52
330537185	0.52
330535379	0.52
330509926	0.52
330502787	0.52
330339052	0.52
330310645	0.52
330320134	0.52
330243048	0.52
330518167	0.52
330482237	0.52
330447673	0.52
330429637	0.52
330422269	0.52
330369073	0.52
330399395	0.52
330315004	0.52
330313965	0.52
330706278	0.52
330520700	0.52
330489648	0.52
330459260	0.52
330445414	0.52
330420614	0.52
330406310	0.52
330323886	0.52
330271257	0.52
330563685	0.52
330556855	0.52
330535424	0.52
330518229	0.52
330520874	0.52
330524343	0.52
330346256	0.52
330329193	0.52
330239389	0.52
330633686	0.52
330574642	0.52
330539637	0.52
330537373	0.52
330520078	0.52
330458249	0.52
330420751	0.52
330295032	0.52
330264232	0.52
330236489	0.52
330256572	0.52
330645307	0.52
330492492	0.52
330474164	0.52
330458761	0.52
330323224	0.52
330302457	0.52
330267492	0.52
330709970	0.52
330697398	0.52
330691166	0.52
330667276	0.52
330643724	0.52
330607053	0.52
330570139	0.52
330486996	0.52
330430168	0.52
330417702	0.52
330421334	0.52
330272063	0.52
330661053	0.52
330512260	0.52
330440707	0.52
330401480	0.52
330424448	0.52
330369349	0.52
330310643	0.52
330299634	0.52
330710387	0.52
330647147	0.52
330569878	0.52
330544525	0.52
330470296	0.52
330427033	0.52
330347285	0.52
330293448	0.52
330305974	0.52
330636176	0.52
330514465	1.3
330530887	1.3
330448804	0.78
330438307	0.52
330456569	0.78
330437282	0.78
330482837	1.3
330476697	0.78
330275011	0.78
330416552	0.26
330416210	0.26
330416261	0.26
330444425	0.52
330416523	0.26
330417616	0.78
330416491	0.78
330416481	0.78
330416520	0.26
330416549	1.82
330416533	0.78
330416500	0.78
330416545	2.86
330416516	0.78
330416387	0.26
330416364	0.26
330416283	0.26
330416405	0.26
330226697	0.52
330224126	0.52
330213260	0.52
330201721	0.78
330204488	0.52
330204927	0.52
330198178	0.52
330214999	1.3
330198374	0.52
330202470	0.52
330207917	0.52
330214776	0.52
330164216	0.78
329951958	0.52
330175156	1.04
330176282	0.78
330159540	0.52
330177274	0.52
330169075	0.52
330175299	0.26
330174613	0.52
330149348	0.52
330150950	0.52
330148988	0.78
330151287	0.52
330149072	0.78
330138398	0.52
330152287	0.78
330165690	0.52
330160246	0.78
330148873	1.04
330163436	0.52
330151696	0.52
330152615	0.52
330135003	0.52
330151566	0.52
330072476	0.52
330148844	0.26
330073580	0.52
330101864	0.26
330046707	0.52
330045413	0.52
330041944	0.52
330043652	0.52
330045150	0.52
330161318	0.78
330043258	0.52
330047247	0.52
330039141	0.52
330059616	0.52
330039326	0.52
330051478	0.52
330041550	0.52
330042325	0.52
330061371	0.52
330021652	0.52
330024679	0.52
330029075	0.78
330020210	0.52
330028003	0.52
330025644	0.52
329993347	0.52
329993440	0.26
329993363	0.52
329993370	0.52
329993439	0.52
329993355	0.52
329993364	0.52
329993438	0.52
329993362	0.52
329993402	0.52
329992703	0.52
329993358	0.52
329993385	0.52
329993461	0.52
330036431	0.52
329993470	0.52
330187640	0.52
329954718	0.5
329954702	0.5
329954711	0.25
330149268	0.25
330030728	0.5
330039490	0.5
329993456	0.5
329954748	0.52
329944466	0.26
329947443	0.52
329900679	0.26
329901034	0.26
329901140	0.26
329801017	0.52
329953560	0.52
329954705	0.52
329901137	0.75
329901097	0.26
329790772	0.52
329768259	1.3
329738721	0.52
329954719	0.52
329934347	0.78
329926787	0.52
329904151	0.52
329900816	0.26
329901320	0.26
329901025	0.26
329737081	0.52
329709192	0.52
329901062	2.75
329681990	0.52
329954730	0.52
329945825	0.52
329916880	0.52
329901042	0.26
329706235	0.52
329942676	0.52
329755543	0.52
329745493	0.52
329715904	0.52
329954721	0.52
329901336	0.26
329900947	0.26
329954715	0.52
329954549	0.52
329901376	0.26
329791286	0.52
329712998	0.52
329681368	0.52
329954709	0.52
329901350	0.26
329901144	0.26
329891343	0.5
329891357	0.52
329938361	0.52
329901353	0.26
329758997	0.52
329742106	0.52
329954703	0.52
329954740	0.52
329942981	0.26
329901158	0.26
329901092	0.26
329900717	0.26
329790335	0.78
329780846	0.52
329782595	0.52
329724725	0.52
329726302	0.52
329954700	0.52
329901103	0.78
329782772	0.52
329757835	0.52
329982159	0.78
329954714	0.52
329900940	0.26
329899675	0.52
329901008	0.26
329954710	0.52
329706778	0.52
329741492	0.52
329901001	0.26
329900727	0.26
329746060	0.52
329900728	0.26
329917110	0.52
329901054	0.26
329954717	0.52
329942966	0.52
329901299	0.26
329680885	0.52
329387365	0.78
329663653	0.52
329901080	0.78
329901226	0.52
329901099	0.78
329901368	0.78
329901123	0.78
329907887	0.52
329901161	0.26
329901083	0.78
329917439	0.52
329901084	0.78
329901129	0.78
329921897	0.78
329904662	0.52
329901098	0.78
329679735	0.52
329847209	0.52
329784181	0.52
329768909	0.52
329785599	0.52
329821406	0.78
329874639	0.52
329789569	0.52
329586141	1.3
329604413	0.26
329589925	0.78
329604526	0.26
329704342	0.52
329729026	0.52
329743861	0.52
329542923	0.78
329936409	0.52
329943784	0.26
329940342	0.52
329935044	0.52
329926447	0.52
329660757	0.52
329656470	0.52
329625439	1.3
329604754	0.26
329604624	0.26
329604757	0.26
329604540	0.78
329604847	0.78
329604521	0.26
329604729	0.78
329604927	0.78
329604692	0.26
329780143	0.25
329813365	0.5
329748165	0.5
329749381	0.25
329624833	0.52
329603717	0.25
329488217	0.52
329641902	0.52
329489545	0.52
329479060	0.52
329473624	0.52
329438748	0.52
329393086	0.52
329418685	0.52
329447195	0.52
329537694	0.52
329406313	0.52
329631485	0.52
329390472	0.52
329646524	0.52
329630311	0.52
329581157	0.52
329498080	0.52
329424704	0.52
329389914	0.52
329373097	0.52
329196687	0.78
329199060	0.78
329603759	0.25
329204822	0.78
329630099	0.52
329534384	0.52
329407340	0.52
329241086	0.78
329196592	0.26
329196818	0.78
329606990	0.5
329423484	0.52
329499313	0.52
329418449	0.52
329632660	0.52
329628189	0.52
329604920	0.75
329487943	0.52
329460206	0.52
329436917	0.52
329423727	0.52
329655047	0.52
329398348	0.52
329398013	0.52
329494137	0.52
329470662	0.52
329633624	0.52
329612774	0.52
329489179	0.52
329446872	0.52
329389789	0.52
329639512	0.52
329557706	0.52
329469179	0.52
329407436	0.52
329402524	0.52
329196645	0.26
328924040	0.78
328966229	0.78
329196526	0.26
329603811	0.5
329450580	0.5
329201299	0.52
329164050	0.52
329085865	0.52
329117366	0.52
329057873	0.52
329026334	0.52
328967107	0.52
328930167	0.52
329245303	0.52
329197921	0.5
329069351	0.52
328939215	0.52
329163073	0.52
329141559	0.5
329064576	0.5
329047287	0.52
328922587	0.52
329243462	0.52
329227266	0.52
329209659	0.52
329107979	0.52
329027301	0.52
329200714	0.25
329059990	0.52
329230426	0.52
329042867	0.52
328941739	0.52
328920176	0.5
329302903	0.52
329213549	0.52
329219480	0.52
329041610	0.52
329017594	0.52
328940689	0.52
329016609	0.52
328964377	0.52
328927600	0.52
328937880	0.52
328914765	0.52
329174619	0.52
329145195	0.52
329133188	0.52
329108779	0.52
329100668	0.52
329076879	0.52
329033096	0.52
329029095	0.52
328910547	0.52
329253430	0.52
329129858	0.52
329028096	0.52
329104612	0.52
329055908	0.52
329033252	0.52
329206067	0.52
329198043	0.5
329034398	0.52
328979315	0.52
329082411	0.52
328997831	0.52
329163437	0.52
329004181	0.5
328985429	0.52
328971330	0.52
328997116	0.52
328985161	0.52
328958282	0.52
328945500	0.57
329021654	0.52
328891704	0.52
328912117	0.52
329191553	0.52
329127844	0.52
329183179	0.52
329158020	0.52
329013018	0.52
328935989	0.52
328906178	0.52
329115049	0.52
328977178	0.52
328971232	0.52
328972212	0.52
328949820	0.52
328943181	0.52
328927645	0.52
328891645	0.52
329075679	0.52
329074100	0.52
329016800	0.52
328969152	0.52
328925001	0.52
328893085	0.52
329034626	0.52
329132299	0.52
329128877	0.52
329082597	0.52
329070403	0.52
329084017	0.52
329030316	0.52
328991085	0.52
329232768	0.52
329125879	0.52
329118215	0.52
329110318	0.52
329082600	0.52
329023911	0.52
328913568	0.52
329048098	0.52
329035684	0.52
328962818	0.52
328926668	0.52
329039168	0.52
328991037	0.52
328991106	0.52
328910015	0.52
329200673	0.5
329083310	0.52
328917188	0.52
329158768	0.52
329119893	0.52
328987203	0.52
329164016	0.52
329112765	0.52
329091424	0.52
329061093	0.52
329050217	0.52
329003992	0.52
329000015	0.52
328973879	0.52
328949862	0.52
328930161	0.52
328893377	0.52
329123287	0.52
329118139	0.52
329091199	0.52
329079420	0.52
329078085	0.52
329023044	0.52
329003987	0.52
328999873	0.52
328965888	0.52
328951831	0.52
328943046	0.52
328939052	0.52
328936912	0.52
328912785	0.52
328907891	0.52
328893416	0.78
329210200	0.52
329192098	0.52
329181627	0.52
329178728	0.52
329177095	0.52
329173308	0.52
329163920	0.52
329162100	0.52
329152203	0.52
329151091	0.52
329147961	0.52
329126879	0.52
329124720	0.52
329120149	0.52
329114927	0.52
329108377	0.52
329092011	0.52
329082710	0.52
329073925	0.52
329070367	0.52
329035093	0.52
329029629	0.52
329029197	0.52
329024917	0.52
329022696	0.52
329016693	0.52
329006003	0.52
328999927	0.52
328987376	0.52
328969024	0.52
328926609	0.52
328926505	0.52
328925174	0.52
328916606	0.52
328915658	0.52
328910371	0.52
328894817	0.52
328893287	0.52
328889382	0.52
328885305	0.28
329091188	0.5
329052968	0.52
328982844	0.52
329199089	0.5
329087044	0.5
329004144	0.5
328965909	0.5
328895458	0.5
329198056	0.5
328943058	0.5
328895431	0.5
328948970	0.52
328938920	0.52
328888915	0.52
328887855	0.52
328889390	0.52`.split('\n').map(line => {
  const [refId, amount] = line.split('\t')
  return { refId, amount: parseFloat(amount) }
})

async function compare() {
  console.log('PowerBI transactions:', powerBIData.length)
  console.log('PowerBI total:', powerBIData.reduce((s, t) => s + t.amount, 0).toFixed(2))

  const powerBIRefIds = new Set(powerBIData.map(t => t.refId))
  const powerBIByRef = new Map(powerBIData.map(t => [t.refId, t.amount]))

  // Get all Eli Health Per Pick Fee from our DB
  const { data: dbTx } = await supabase
    .from('transactions')
    .select('transaction_id, reference_id, cost')
    .eq('client_id', 'e6220921-695e-41f9-9f49-af3e0cdc828a')
    .eq('fee_type', 'Per Pick Fee')
    .eq('invoice_id_sb', 8730397)
    .is('dispute_status', null)

  console.log('\nDB transactions:', dbTx?.length)
  console.log('DB total:', dbTx?.reduce((s, t) => s + parseFloat(t.cost), 0).toFixed(2))

  const dbRefIds = new Set((dbTx || []).map(t => t.reference_id))
  const dbByRef = new Map((dbTx || []).map(t => [t.reference_id, { txId: t.transaction_id, cost: parseFloat(t.cost) }]))

  // Find transactions in DB but not in PowerBI
  const inDbNotPowerBI = []
  for (const t of (dbTx || [])) {
    if (!powerBIRefIds.has(t.reference_id)) {
      inDbNotPowerBI.push(t)
    }
  }

  // Find transactions in PowerBI but not in DB
  const inPowerBINotDb = []
  for (const t of powerBIData) {
    if (!dbRefIds.has(t.refId)) {
      inPowerBINotDb.push(t)
    }
  }

  // Find amount mismatches
  const amountMismatches = []
  for (const t of powerBIData) {
    const dbEntry = dbByRef.get(t.refId)
    if (dbEntry && Math.abs(dbEntry.cost - t.amount) > 0.001) {
      amountMismatches.push({ refId: t.refId, powerBI: t.amount, db: dbEntry.cost, diff: dbEntry.cost - t.amount })
    }
  }

  console.log('\n=== DISCREPANCIES ===')
  console.log('In DB but NOT in PowerBI:', inDbNotPowerBI.length)
  if (inDbNotPowerBI.length > 0) {
    console.log('  Total cost:', inDbNotPowerBI.reduce((s, t) => s + parseFloat(t.cost), 0).toFixed(2))
    for (const t of inDbNotPowerBI.slice(0, 10)) {
      console.log('  ref:', t.reference_id, 'cost:', t.cost)
    }
  }

  console.log('\nIn PowerBI but NOT in DB:', inPowerBINotDb.length)
  if (inPowerBINotDb.length > 0) {
    console.log('  Total cost:', inPowerBINotDb.reduce((s, t) => s + t.amount, 0).toFixed(2))
    for (const t of inPowerBINotDb.slice(0, 10)) {
      console.log('  ref:', t.refId, 'cost:', t.amount)
    }
  }

  console.log('\nAmount mismatches:', amountMismatches.length)
  if (amountMismatches.length > 0) {
    console.log('  Total diff:', amountMismatches.reduce((s, t) => s + t.diff, 0).toFixed(2))
    for (const t of amountMismatches) {
      console.log('  ref:', t.refId, 'PowerBI:', t.powerBI, 'DB:', t.db, 'diff:', t.diff.toFixed(2))
    }
  }
}

compare().catch(console.error)
